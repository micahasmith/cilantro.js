<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <title>Proto1</title>
    <style type="text/css">
        p,h1,h2,h3,h4,h5,input,em,strong{font-family: Tahoma, Helvetica, Arial, Sans-Serif;}
        .header
        {
            font-size:70px;
            color: #555;
            text-shadow: 0px 2px 3px #555;
        }
        .page 
        { 
            margin: 1px auto;
            padding: 0;
            max-width: 960px;
            min-width: 500px;
            }
        #wrapper
        {
            margin: 1px auto;
            padding: 0;
            max-width: 960px;
            min-width: 500px;
            height: 960px;
            background-color: #eee;
            border: 1px solid #444;
        }
        .container
        {
            position: relative;
            top: 0px;
            left: 0px;
        }
        .box
        {
            background-color: White;
            position: absolute;
            border: 1px solid #444;
            padding: 5px 5px 5px 5px;
        }
        .box1
        {
            background-color: red;
        }
        .box2
        {
            background-color: blue;
        }
        .box3
        {
            background-color: green;
        }
        .box4
        {
            background-color: yellow;
        }
        .box5
        {
            background-color: gray;
        }
        /* http://sonspring.com/journal/clearing-floats */.clear
        {
            clear: both;
            display: block;
            overflow: hidden;
            visibility: hidden;
            width: 0;
            height: 0;
        }
        /* http://www.yuiblog.com/blog/2010/09/27/clearfix-reloaded-overflowhidden-demystified */.clearfix:before, .clearfix:after, .container_12:before, .container_12:after, .container_16:before, .container_16:after
        {
            content: '.';
            display: block;
            overflow: hidden;
            visibility: hidden;
            font-size: 0;
            line-height: 0;
            width: 0;
            height: 0;
        }
        .clearfix:after, .container_12:after, .container_16:after
        {
            clear: both;
        }
        /*
  The following zoom:1 rule is specifically for IE6 + IE7.
  Move to separate stylesheet if invalid CSS is a problem.
*/.clearfix, .container_12, .container_16
        {
            zoom: 1;
        }
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
    <script type="text/javascript">
    //box object constructor
function box() {
    if(!(this instanceof box)) {
       return new box();
       }
    this.width=0;
    this.height=0;
    this.left=0;
    this.right=0;
    this.bottom=0;
    this.top=0;
    this.setLeft=function(val){ this.left=val;this.right=this.left+this.width;};
    this.setTop=function(val){ this.top=val; this.bottom=this.top+this.height;};

       this.id='';
	   this.onrow=0;
	   this.html = '';
	   this.getHtml= function () {
	       return '<div class="box" id="'+this.id+'" style="position:absolute; top:' + this.top + 'px; left:' + this.left + 'px; width:' + this.width + 'px; height:' + this.height + 'px;">' + this.html + '</div>';
	   };
	   this.toString=function() {
		return "id="+this.id+" left="+this.left+" top="+this.top+" right="+this.right+" bottom="+this.bottom;
	   };
    this.reset = function () {
		////console.log("reseting");
        this.left = 0, this.top = 0, this.bottom=0,this.right=0, this.onrow = 0;
    };
};
//boxmanager constructor function
var boxManager = function (containerID) {
    //an array that contains at index 0 the base data
    //at other indexes, rendered versions of the base data
    var boxes = [],
        currentIndex = 0,
        iter = 0,
		iterBox = {},
        margin = 10,
        containerWidth = 960,
        containerHeight = 540,
        currentX = 0,
        currentY = 0,
        addToX = 0,
        addToY = 0,
		nextAddToY = margin,
        currentID = 0,
        container = document.getElementById("container"),
		shiftDown = false,
		onRow = 0,
		nextRow = 0,
        tempbox = {},
        l = function (text) { console.log(text); },
		getID = function () {
		    return (currentID++).toString();
		},
		getTopYForBox = function (thetheboxes, thisBox) {

		    //get the bottom y for theboxes where left is less than left+ margin
		    //and right is greater than left
		    if (thisBox.onrow === 0) { return margin; }
		    var len = theboxes.length,
				maxY = 0;
		    iter = 0;
		    for (; iter < len; iter += 1) {
		        iterBox = theboxes[iter];
		        if (iterBox.onrow < thisBox.onrow) {
		            //if the box we're looking at's left edge is in be
		            if (thisBox.left >= iterBox.left && thisBox.left + margin <= iterBox.left + iterBox.width) {
		                if (iterBox.height + iterBox.top > maxY) {
		                    maxY = iterBox.height + iterBox.top;
		                }
		            }
		            if (thisBox.right + margin >= iterBox.left && thisBox.right + margin <= iterBox.right) {
		                if (iterBox.height + iterBox.top > maxY) {
		                    maxY = iterBox.height + iterBox.top;
		                }
		            }
		        }

		    }
		    return maxY + margin * 2;

		},
        getBoundingBoxesFor = function (baseBox, basis, secondarybasis, recurse) {
            /*
            var len = boxes.length,
            compliment = {
            left: "right",
            top: "bottom",
            right: "left",
            bottom: "top"
            },
            antibasis=compliment[basis],
            antisecondarybasis=compliment[secondarybasis],
            maxBasis = 0;
            iter = 0;
            for (; iter < len; iter += 1) {
            compBox = boxes[iter];
            //if the base box's top is less than base box's bottom
            //if the base box's left is less than comparison's box's left
            //or 
            if(baseBox[secondarybasis] < compBox[antisecondarybasis] && ( baseBox[basis] <= compBox[basis] && basebox[antibasis]<=compBox[antibasis])){
            if (iterBox.height + iterBox.top > maxY) {
            maxY = iterBox.height + iterBox.top;
            }
            }
            }
            return maxY + margin * 2;
            }
            */
        },
		process = function (newindexboxes, item) {
		    var i = 0,
			boxlen = newindexboxes.length
		    tbox = {},
		    //winnerbox={},
			maxy = margin;
		    for (; i < boxlen; i += 1) {
		        tbox = newindexboxes[i];
		        if ((tbox.bottom + margin) > maxy && ((tbox.right > item.left - margin && tbox.right < item.right + margin) || (tbox.left > item.left - margin && tbox.left < item.right + margin) || (tbox.left < item.left && tbox.right > item.left))) {
		            //////console.log("using maxy from "+tbox.toString()+ " for " +item.toString());
		            maxy = tbox.bottom + margin;
		            //winnerbox=boxes[i];
		        }
		    }
		    ////console.log("using maxy from "+winnerbox.toString()+ " for " +item.toString());
		    return maxy + margin;
		},
        resetPaint = function () {
            //l("resetpaint");
            //            var i = 0,
            //			boxlength = boxes.length;
            //            for (; i < boxlength; i += 1) {
            //                boxes[i].reset();
            //            }
            addToX = 0, addToY = 0, onRow = 0, nextRow = 0,
            containerWidth = $(container).width();

        },
    calculateBounds = function (newindexboxes, newbox) {
        //l("calculateBounds");
        if (addToX === 0 && addToX !== margin) {
            addToX = margin;
        }
        if ((addToX + newbox.width + margin * 2) > containerWidth) {
            addToX = margin;
            onRow += 1;
        }
        if (onRow === nextRow) {
            if (newbox.height + addToY > nextAddToY) {
                nextAddToY = newbox.height + addToY;
            }
        }
        if (onRow !== nextRow) {
            nextRow += 1;
            addToY = nextAddToY + margin * 2;
        }
        newbox.onrow = onRow;
        newbox.setLeft(addToX);
        //newbox.setTop(getTopYForBox(newbox));
        newbox.setTop(process(newindexboxes, newbox));
        addToX = newbox.left + newbox.width + margin * 2;
        return newbox;
    },
        addBox = function (newbox) {
            //always add boxes to index 0, the basis
            if (boxes.length === 0) {
                boxes.push(new Array());
            }
            boxes[0].push(newbox);

        },
    boxFactory = function (defaults) {
        tempbox = new box();
        if (defaults !== 'undefined') {
            tempbox = $.extend(tempbox, defaults);
        }
        tempbox.id = currentID;
        currentID += 1;
        return tempbox;
    },
    //render gets the last perspective and paints it
    render = function (index) {
        var boxlength = 0,
        $container = $(container);
        if (isNaN(index)) {
            index = boxes.length - 1;
        }
        boxlength = boxes[index].length;
        $container.html("");
        for (iter = 0; iter < boxlength; iter += 1) {
            $container.append(boxes[index][iter].getHtml());
        }
        $container.find("div").hide().show("slow");
    },
    prep = function () {
        //l("paint");
        var i = 0,
        boxlength = boxes[0].length,
        newindexboxes = [],
        newbox = {};
        resetPaint();
        for (; i < boxlength; i += 1) {
            //make the new perspective of the base data, 
            //push it into the new perspective array
            newbox = new box();
            newbox = $.extend(newbox, boxes[0][i]);
            newindexboxes.push(calculateBounds(newindexboxes, newbox));
        }
        //add the perspective to all of them
        boxes.push(newindexboxes);
    },
    transistion = function (fromindex, toindex, itemfunction) {
        var i = 0,
        boxlen = boxes[fromindex].length;
        for (; i < boxlen; i += 1) {
            itemfunction(boxes[fromindex][i], boxes[toindex][i],container);
        }
    },
    getCurrentIndex = function () {
        return boxes.length - 1;
    };

    //return functions we select as the public api, not the private data
    return {
        addBox: addBox,
        boxFactory: boxFactory,
        prep: prep,
        render: render,
        transistion: transistion,
        boxes: boxes,
        getCurrentIndex: getCurrentIndex
    };

};

$(function () {
    var bm = new boxManager('container'),
    box = {},
    iter = 0,
    timeout = false,
    timeoutmax = 500;

    window.bm = bm;

    var abox = bm.boxFactory({ width: 100, height: 200, html: "<p>1 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 130, height: 50, html: "<p>2 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 55, html: "<p>3 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 300, height: 200, html: "<p>4 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 125, height: 250, html: "<p>5 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 125, html: "<p>6 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 125, html: "<p>7 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 125, html: "<p>8 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 130, height: 50, html: "<p>9 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 325, height: 250, html: "<p>10 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 55, html: "<p>11 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 125, height: 250, html: "<p>12 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 130, height: 50, html: "<p>13 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 55, height: 55, html: "<p>14 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 300, height: 200, html: "<p>15 hi</p>" });
    bm.addBox(abox);

    abox = bm.boxFactory({ width: 125, height: 250, html: "<p>16 hi</p>" });
    bm.addBox(abox);

    bm.prep();
    bm.render();

    $(window).resize(function () {
        var options = { distance: 10 };
        clearTimeout(timeout);
        timeout = setTimeout(function () {
            var index = bm.getCurrentIndex();
            bm.prep();
            bm.transistion(index, bm.getCurrentIndex(), function (oldone, newone, context) {
                $("#" + oldone.id, context).animate({
                    top: newone.top,
                    left: newone.left

                }, 500, function () {
//                    if (oldone.top !== newone.top) {
//                        var distance = Math.floor(Math.random() * 11);
//                        var times = Math.floor(Math.random() * 11);
//                        var direction=oldone.top> newone.top ? "down":"up";
//                        $(this).effect("bounce", { distance: distance,direction: direction, times:times }, 100);
//                    } else
                    if (oldone.left !== newone.left) {
                        var distance = Math.floor(Math.random() * 11);
                        var times = Math.floor(Math.random() * 11);
                        var direction=oldone.left> newone.left ? "left":"right";

                        $(this).effect("bounce", { distance: distance, times: times,direction:direction }, 100);

                    }
                });
            });
        }, timeoutmax);


    });
})


		</script>
</head>
<body>
    <div class="page">
        <h1 class="header">Proto1</h1>
    </div>
    <div id="wrapper">
        <div id="container" class="container">
        </div>
    </div>
</body>
</html>
